# Agent 2: Vulnerability Assessment

## Purpose
Automated vulnerability scanning and assessment across web applications, containers, and dependencies. Discovers CVEs, enriches with CVSS/EPSS scores, prioritizes by risk, and generates AI-powered remediation steps using Claude.

## Workflow Overview

```
Webhook Trigger (POST)
  → Get Assets from Airtable (filtered by client_id, scan_enabled=true)
  → Loop Over Assets:
      → Determine asset_type (web_app, container, dependency)
      → Branch by type:
          ├─ web_app → Snyk Web Scan
          ├─ container → Snyk Container Scan
          └─ dependency → OSV.dev Query
      → For each vulnerability found:
          → Enrich with NVD (CVSS details)
          → Enrich with EPSS (exploit probability)
          → Query GitHub Advisory Database
          → Calculate Priority Score (Code node)
          → Generate Remediation with Claude API
          → Check Existing in Airtable (dedup by CVE + asset)
          → Create or Update Vulnerability record
  → Generate Summary Report (Code node)
  → Webhook Response
```

## Webhook Endpoint

- **Method**: POST
- **Path**: `/webhook/vuln-assessment-start`
- **Auth**: HTTP Header Auth (`X-API-Key`)

### Request Payload

```json
{
  "client_id": "CL001",
  "scan_type": "full",
  "asset_filter": "all"
}
```

### Response

```json
{
  "assessment_id": "VA1234567890",
  "client_id": "CL001",
  "assets_scanned": 5,
  "vulnerabilities_found": 12,
  "critical": 2,
  "high": 3,
  "medium": 5,
  "low": 2,
  "timestamp": "2024-01-10T12:00:00.000Z",
  "status": "completed"
}
```

## Required Credentials (configure in n8n)

| Credential | n8n Type | Header / Field | Free Tier |
|---|---|---|---|
| Airtable Personal Access Token | Airtable Token API | — | 1,200 records/base |
| Snyk API Token | HTTP Header Auth | `Authorization: token XXX` | 200 tests/month |
| Anthropic Claude API Key | HTTP Header Auth | `x-api-key` | Pay-per-use |

### Optional (Recommended)

| Credential | n8n Type | Header / Field | Benefit |
|---|---|---|---|
| NVD API Key | HTTP Header Auth | `apiKey` | 50 req/30s (vs 5 without) |
| GitHub Token | HTTP Header Auth | `Authorization: Bearer XXX` | Higher rate limits |

### No Key Required
- **OSV.dev** — open source vulnerability DB (`POST https://api.osv.dev/v1/query`)
- **EPSS API** — exploit prediction scores (`GET https://api.first.org/data/v1/epss?cve=CVE-XXXX-XXXX`)
- **GitHub Security Advisory DB** — GraphQL (`POST https://api.github.com/graphql`)

## Airtable Schema

### Assets
| Field | Type |
|---|---|
| asset_id | Single line text |
| client_id | Single line text |
| asset_type | Single select: web_app, container, dependency |
| asset_name | Single line text |
| asset_identifier | Single line text |
| operating_system | Single line text |
| criticality | Single select: Low, Medium, High, Critical |
| tags | Single line text |
| scan_enabled | Checkbox |

### Vulnerabilities
| Field | Type |
|---|---|
| vulnerability_id | Single line text |
| client_id | Single line text |
| asset_id | Link to Assets |
| cve_id | Single line text |
| title | Single line text |
| description | Long text |
| severity | Single select: CRITICAL, HIGH, MEDIUM, LOW |
| cvss_score | Number (0-10) |
| epss_score | Number (0-1) |
| priority_score | Number (computed) |
| priority_level | Single select: P1, P2, P3, P4 |
| discovered_date | Date |
| due_date | Date |
| status | Single select: Open, In Progress, Resolved, Accepted |
| assigned_to | Single line text |
| remediation_steps | Long text |
| package_name | Single line text |
| package_version | Single line text |
| fixed_in | Single line text |
| sla_days | Number |

## Priority Score Calculation

```javascript
// Priority = weighted combination of CVSS, EPSS, and asset criticality
const criticalityWeight = { Critical: 1.0, High: 0.75, Medium: 0.5, Low: 0.25 };
const priorityScore = (cvss_score * 0.4) + (epss_score * 100 * 0.35) + (criticalityWeight[asset_criticality] * 10 * 0.25);

// Priority Levels:
// P1 (Critical): score >= 8.0  → SLA: 7 days
// P2 (High):     score >= 6.0  → SLA: 30 days
// P3 (Medium):   score >= 4.0  → SLA: 90 days
// P4 (Low):      score < 4.0   → SLA: 180 days
```

## API Reference

### Snyk — Test a package
```
GET https://api.snyk.io/v1/test/{ecosystem}/{package}/{version}
Authorization: token {SNYK_TOKEN}
```

### OSV.dev — Query by package
```
POST https://api.osv.dev/v1/query
{ "package": { "name": "axios", "ecosystem": "npm" }, "version": "0.21.1" }
```

### NVD — Lookup CVE
```
GET https://services.nvd.nist.gov/rest/json/cves/2.0?cveId=CVE-2021-3749
apiKey: {NVD_KEY}
```

### EPSS — Get exploit probability
```
GET https://api.first.org/data/v1/epss?cve=CVE-2021-3749
```

### Claude — Generate remediation
```
POST https://api.anthropic.com/v1/messages
x-api-key: {ANTHROPIC_KEY}
anthropic-version: 2023-06-01
{
  "model": "claude-sonnet-4-20250514",
  "max_tokens": 1024,
  "messages": [{ "role": "user", "content": "Generate step-by-step remediation for CVE-2021-3749 affecting axios 0.21.1 in an npm project..." }]
}
```

## Troubleshooting

- **Snyk 401**: Verify token format is `token YOUR_TOKEN` (not `Bearer`).
- **OSV.dev empty results**: Check ecosystem name matches exactly (e.g., `npm` not `NPM`).
- **NVD rate limited**: Add 6-second delay between calls (or use API key for 50/30s).
- **EPSS returns no data**: CVE may be too new — EPSS updates daily.
- **Claude API errors**: Check `anthropic-version` header is set, verify API key.
